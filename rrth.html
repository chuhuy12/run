<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Running Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link
    href="bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- jQuery + jQuery UI (for PivotTable) -->
  <script src="jquery-3.6.0.min.js"></script>
  <link
    rel="stylesheet"
    href="jquery-ui.css"
  />
  <script src="jquery-ui.min.js"></script>

  <!-- PivotTable.js -->
  <link
    rel="stylesheet"
    href="pivot.min.css"
  />
  <script src="pivot.min.js"></script>

  <!-- DataTables -->
  <link
    rel="stylesheet"
    href="jquery.dataTables.min.css"
  />
  <script src="jquery.dataTables.min.js"></script>

  <!-- SheetJS -->
  <script src="xlsx.full.min.js"></script>

  <style>
    body {
      background-color: #287f75;
      color: white;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px 0 50px 0;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      background: white;
      color: black;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 40px;
      width: 95%;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .section h4 {
      margin-bottom: 12px;
    }
    .filter-input {
      margin-bottom: 10px;
    }
    /* Pivot table container with fixed height */
    #pivotTableCurrentWeek,
    #pivotTableLastWeek {
      height: 40vh;
      overflow: auto;
    }
    /* DataTables wrapper with fixed height and scroll */
    .table-wrapper {
      max-height: 40vh;
      overflow-y: auto;
    }
    table.dataTable thead th {
      cursor: pointer;
    }
    table caption {
      caption-side: top;
      font-weight: bold;
      font-size: 1.2em;
      padding-bottom: 8px;
      color: #287f75;
    }
    button.export-btn {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üèÉ‚Äç‚ôÇÔ∏è Running Dashboard</h2>

    <!-- Data Table 1 -->
    <section class="section">
      <h4>Tu·∫ßn hi·ªán t·∫°i</h4>
      <input
        type="text"
        id="dataFilter1"
        class="form-control filter-input"
        placeholder="Filter Data Tu·∫ßn hi·ªán t·∫°i..."
      />
      <div class="table-wrapper">
        <table id="dataTableCurrentWeek" class="display" width="100%">
          <caption>Athlete Activities</caption>
        </table>
      </div>
      <button class="btn btn-secondary export-btn" onclick="exportTableToExcel('dataTableCurrentWeek')">
        Export Excel
      </button>
    </section>

    <!-- Data Table 2 -->
    <section class="section">
      <h4>Tu·∫ßn tr∆∞·ªõc</h4>
      <input
        type="text"
        id="dataFilter2"
        class="form-control filter-input"
        placeholder="Filter Data Tu·∫ßn tr∆∞·ªõc..."
      />
      <div class="table-wrapper">
        <table id="dataTableLastWeek" class="display" width="100%">
          <caption>Athlete Activities</caption>
        </table>
      </div>
      <button class="btn btn-secondary export-btn" onclick="exportTableToExcel('dataTableLastWeek')">
        Export Excel
      </button>
    </section>

    <!-- Pivot Table 1 -->
    <section class="section">
      <h4>Pivot Table - Tu·∫ßn hi·ªán t·∫°i</h4>
      <input
        type="text"
        id="pivotFilter1"
        class="form-control filter-input"
        placeholder="Filter Pivot Table Tu·∫ßn hi·ªán t·∫°i..."
      />
      <div id="pivotTableCurrentWeek"></div>
      <button class="btn btn-secondary export-btn" onclick="exportPivot('pivotTableCurrentWeek')">
        Export Excel
      </button>
    </section>

    <!-- Pivot Table 2 -->
    <section class="section">
      <h4>Pivot Table - Tu·∫ßn tr∆∞·ªõc</h4>
      <input
        type="text"
        id="pivotFilter2"
        class="form-control filter-input"
        placeholder="Filter Pivot Table 2..."
      />
      <div id="pivotTableLastWeek"></div>
      <button class="btn btn-secondary export-btn" onclick="exportPivot('pivotTableLastWeek')">
        Export Excel
      </button>
    </section>

  </div>

  <script>
    // YOUR Supabase API info here:
  const API1 = 'https://gunwsbbzgagizxxystdq.supabase.co/rest/v1/v_rrth_data_current_week?select=*';
  const API2 = 'https://gunwsbbzgagizxxystdq.supabase.co/rest/v1/v_rrth_data_last_week?select=*';
  const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1bndzYmJ6Z2FnaXp4eHlzdGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1Nzk0MDYsImV4cCI6MjA2ODE1NTQwNn0.CIFTxv6lmDTGnSIu2IZcVfkPtGMc-r4c1pRm34Pkixo';

    const HEADERS = {
      apikey: API_KEY,
      Authorization: "Bearer " + API_KEY,
    };

    // Fetch from Supabase
    async function fetchData(url) {
      try {
        const res = await fetch(url, { headers: HEADERS });
        if (!res.ok) throw new Error("Network response was not ok");
        return await res.json();
      } catch (e) {
        alert("Fetch error: " + e.message);
        return [];
      }
    }

    // Render pivot table
    function renderPivot(id, data) {
      $("#" + id).pivotUI(data, {
        rendererName: "Table",
        width: "95%",
        height: "40vh",
      });
    }

    // Export pivot table to Excel
    function exportPivot(id) {
      const table = document.querySelector(`#${id} table`);
      if (!table) {
        alert("Pivot table not loaded yet.");
        return;
      }
      const wb = XLSX.utils.table_to_book(table);
      XLSX.writeFile(wb, id + ".xlsx");
    }

    // Render DataTable with filters and sorting
    function renderDataTable(tableId, data) {
      if (!data.length) return;

      const cols = Object.keys(data[0]).map((k) => ({ title: k, data: k }));
      const table = $(`#${tableId}`).DataTable({
        data,
        columns: cols,
        destroy: true,
        scrollY: "35vh",
        scrollCollapse: true,
        paging: false,
        order: [],
        dom: "rt", // Only table (no search/pagination controls)
      });

      // Filter input connected to table search
      $(`#${tableId.replace("dataTable", "dataFilter")}`).off("keyup").on("keyup", function () {
        table.search(this.value).draw();
      });
    }

    // Export DataTable to Excel
    function exportTableToExcel(tableId) {
      const table = document.querySelector(`#${tableId}`);
      if (!table) {
        alert("Table not loaded yet.");
        return;
      }
      const wb = XLSX.utils.table_to_book(table);
      XLSX.writeFile(wb, tableId + ".xlsx");
    }

    async function initDashboard() {
      const [data1, data2] = await Promise.all([fetchData(API1), fetchData(API2)]);

      // Render pivot tables
      renderPivot("pivotTableCurrentWeek", data1);
      renderPivot("pivotTableLastWeek", data2);

      // Render data tables
      renderDataTable("dataTableCurrentWeek", data1);
      renderDataTable("dataTableLastWeek", data2);
    }

    $(document).ready(() => {
      initDashboard();
    });
  </script>
</body>
</html>
